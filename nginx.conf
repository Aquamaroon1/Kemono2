# limit amount of thumbnail processing to avoid performance issues
limit_req_zone key zone=one:10m rate=20r/s;

server {
    root /storage;
    location /icons { try_files $uri @kemono_archiver; }
    location /thumbnail { try_files $uri @kemono_thumbnails; }
    location / { try_files $uri @kemono; }
    location @kemono {
        include uwsgi_params;
        uwsgi_pass unix:/tmp/kemono.sock;
    }
    location @kemono_thumbnails {
        include uwsgi_params;
        uwsgi_pass unix:/tmp/kemono.sock;
        limit_req zone=one burst=1000 nodelay;
    }
    location @kemono_archiver {
        proxy_pass http://kemono-archiver;
    }
}
